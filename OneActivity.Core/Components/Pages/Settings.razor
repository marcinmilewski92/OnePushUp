@page "/settings"
@using OneActivity.Core.Components.SettingsComponents
@using OneActivity.Core.Services
@inject UserService UserService
@inject NotificationService NotificationService
@inject ISharedContent Shared

<div class="container mt-4">
    <div class="row">
        <div class="col-md-6">
            @if (CurrentUser != null)
            {
                <EditNickname />
            }
            else
            {
                <SettingsNoUserAlert />
            }
        </div>
        
        <div class="col-md-6 mb-4">
            <LanguageSettings />
            <GenderSettings />
            <NotificationSettings />
            
            <NotificationTestCard IsTesting="@_isTestingNotification" NotificationTestMessage="@_notificationTestMessage" NotificationTestError="@_notificationTestError" OnSendTest="SendTestNotification" />
        </div>
    </div>
    
</div>

@code {
    private bool _isTestingNotification;
    private string _notificationTestMessage = string.Empty;
    private bool _notificationTestError;
    
    private async Task SendTestNotification()
    {
        try
        {
            _isTestingNotification = true;
            _notificationTestMessage = string.Empty;
            
            await NotificationService.SendTestNotificationAsync();
            
            _notificationTestMessage = Shared.NotificationTestSuccess(DateTime.Now.ToString("HH:mm:ss"));
            _notificationTestError = false;
        }
        catch (Exception ex)
        {
            _notificationTestMessage = $"{Shared.NotificationTestErrorPrefix} {ex.Message}";
            _notificationTestError = true;
        }
        finally
        {
            _isTestingNotification = false;
        }
    }
}
